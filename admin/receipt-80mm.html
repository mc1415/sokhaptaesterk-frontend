<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>80mm Receipt</title>
    <link rel="stylesheet" href="css/receipt-80mm.css">
</head>

<body>
    <div class="receipt">
        <div class="receipt-header">
            <img src="../assets/logo.png" alt="Logo" class="logo">
            <p class="store-name" style="font-family: Moul;">·ûü·ûª·ûÅ·û∂·ûï·üí·ûë·üá·ûë·ûπ·ûÄ</p>
            <p>Tel: +855 78 659 799</p>
        </div>

        <div class="receipt-info">
            <p>Receipt No: <span id="receipt-no"></span></p>
            <p>Date: <span id="receipt-date"></span></p>
            <p>Cashier: <span id="receipt-cashier"></span></p>
        </div>

        <table class="items-table">
            <thead>
                <tr>
                    <th style="text-align: left;">Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="receipt-items">
                <!-- Items will be injected here -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="total-label">Subtotal</td>
                    <td class="total-value" id="receipt-subtotal"></td>
                </tr>
                <tr>
                    <td colspan="3" class="total-label">Tax (0%)</td>
                    <td class="total-value" id="receipt-tax"></td>
                </tr>
                <tr class="grand-total">
                    <td colspan="3">TOTAL (THB)</td>
                    <td id="receipt-total-thb"></td>
                </tr>
                 <tr class="grand-total secondary">
                    <td colspan="3">TOTAL (USD)</td>
                    <td id="receipt-total-usd"></td>
                </tr>
            </tfoot>
        </table>

        <div class="receipt-footer">
            <p>Thank you for your business!</p>
            <p>·ûü·ûº·ûò·û¢·ûö·ûÇ·ûª·ûé!</p>
        </div>
    </div>

    <button id="printnode-btn" style="width:100%;padding:12px;margin:10px 0;">üñ® Send to PrintNode</button>

    <!-- Scripts -->
    <script src="js/apiService.js"></script> 
    <script src="js/config.js"></script>
    <script src="js/currencyHelper.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/receipt-80mm.js"></script>
    <script src="js/receipt-printer-encoder.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!--<script>
        document.getElementById('printnode-btn').addEventListener('click', async () => {
          try {
            const receipt = document.querySelector('.receipt');
        
            // ‚úÖ Force .receipt to expand fully before capture
            receipt.style.height = 'auto';
            receipt.style.overflow = 'visible';
        
            // ‚úÖ STEP 1: Render receipt to canvas
            const canvas = await html2canvas(receipt, { 
              scale: 3, 
              useCORS: true, 
              windowHeight: document.body.scrollHeight   // ‚úÖ ensures full content capture
            });
        
            // ‚úÖ STEP 2: Convert canvas height (px ‚Üí mm)
            const pxToMm = px => px / 3.78;
            const canvasHeightMm = pxToMm(canvas.height);
        
            console.log(`üìù Canvas height used for PDF: ${canvasHeightMm}mm`);
        
            // ‚úÖ STEP 3: html2pdf options using canvas height
            const opt = {
              margin: 0,
              filename: `TEST-Receipt.pdf`,
              image: { type: 'jpeg', quality: 1.0 },
              html2canvas: { scale: 3, useCORS: true },
              jsPDF: {
                unit: 'mm',
                format: [80, canvasHeightMm],   // ‚úÖ 80mm wide, dynamic height
                orientation: 'portrait'
              },
              pagebreak: { mode: ['avoid'] }
            };
        
            // ‚úÖ STEP 4: Save PDF locally (for testing)
            await html2pdf().from(receipt).set(opt).save();
        
            alert("‚úÖ PDF saved with full receipt height!");
          } catch (err) {
            console.error("‚ùå PDF error:", err);
            alert("‚ùå PDF generation failed: " + err.message);
          }
        });
    </script> -->
    <!-- The final, corrected script block -->
<!-- The final, definitive script block for 1:1 printing -->
<script>
document.getElementById('printnode-btn').addEventListener('click', async () => {
    // 1. SETUP THE CAPTURE ENVIRONMENT
    const originalReceipt = document.querySelector('.receipt');
    if (!originalReceipt) {
        alert("Error: .receipt element not found.");
        return;
    }

    const receiptClone = originalReceipt.cloneNode(true);
    const captureContainer = document.createElement('div');
    
    // The standard pixel width for an 80mm thermal printer at 203 DPI is 576px.
    const printerWidthPx = 576;

    Object.assign(captureContainer.style, {
        position: 'absolute',
        top: '0',
        left: '0',
        zIndex: '-1',
        opacity: '0',
        width: `${printerWidthPx}px` // Render at the printer's native pixel width
    });

    captureContainer.appendChild(receiptClone);
    document.body.appendChild(captureContainer);
    
    try {
        // 2. CAPTURE THE ELEMENT TO A CANVAS AT NATIVE RESOLUTION
        const canvas = await html2canvas(receiptClone, {
            scale: 1, // Use scale 1 because we are already at the target resolution
            useCORS: true,
            scrollY: 0,
        });

        // 3. CREATE A PERFECTLY SIZED PDF DOCUMENT
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        
        const pdfWidthMm = 80; // The physical paper width
        // Calculate the height in mm to maintain the aspect ratio of the captured image
        const pdfHeightMm = (canvas.height * pdfWidthMm) / canvas.width;

        // Create a jsPDF document with the EXACT calculated dimensions
        const pdf = new jspdf.jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: [pdfWidthMm, pdfHeightMm]
        });

        // Add the captured image to the PDF, stretching it to fit the page perfectly
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidthMm, pdfHeightMm);
        
        // 4. GET BASE64 AND PREPARE PAYLOAD
        const dataUri = pdf.output('datauristring');
        const base64PDF = dataUri.split(',')[1];
        
        const apiKey = "fuTUtDy28kvT6oNf3V84ip-nc6P_yltRzI7Iogmf2qk";
        const printerId = 74589060;

        const printNodePayload = {
            printerId: printerId,
            title: "Receipt",
            contentType: "pdf_base64",
            content: base64PDF,
            source: "POS System",
            options: {
                "fit_to_page": false // This is still essential
            }
        };
        
        // 5. SEND TO PRINTNODE
        const response = await fetch("https://api.printnode.com/printjobs", {
            method: "POST",
            headers: {
                "Authorization": "Basic " + btoa(apiKey + ":"),
                "Content-Type": "application/json"
            },
            body: JSON.stringify(printNodePayload)
        });

        const result = await response.json();
        if (!response.ok) throw new Error(result.message || "PrintNode request failed");

        alert("‚úÖ Receipt sent to printer!");

    } catch (err) {
        console.error("‚ùå Printing error:", err);
        alert("‚ùå " + err.message);
    } finally {
        // 6. CLEAN UP
        document.body.removeChild(captureContainer);
    }
});
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

</body>
</html>
