<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>80mm Receipt</title>
    <link rel="stylesheet" href="css/receipt-80mm.css">
</head>

<body>
    <div class="receipt">
        <div class="receipt-header">
            <img src="../assets/logo.png" alt="Logo" class="logo">
            <p class="store-name" style="font-family: Moul;">·ûü·ûª·ûÅ·û∂·ûï·üí·ûë·üá·ûë·ûπ·ûÄ</p>
            <p>Tel: +855 78 659 799</p>
        </div>

        <div class="receipt-info">
            <p>Receipt No: <span id="receipt-no"></span></p>
            <p>Date: <span id="receipt-date"></span></p>
            <p>Cashier: <span id="receipt-cashier"></span></p>
        </div>

        <table class="items-table">
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="receipt-items">
                <!-- Items will be injected here -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="3" class="total-label">Subtotal</td>
                    <td class="total-value" id="receipt-subtotal"></td>
                </tr>
                <tr>
                    <td colspan="3" class="total-label">Tax (0%)</td>
                    <td class="total-value" id="receipt-tax"></td>
                </tr>
                <tr class="grand-total">
                    <td colspan="3">TOTAL (THB)</td>
                    <td id="receipt-total-thb"></td>
                </tr>
                 <tr class="grand-total secondary">
                    <td colspan="3">TOTAL (USD)</td>
                    <td id="receipt-total-usd"></td>
                </tr>
            </tfoot>
        </table>

        <div class="receipt-footer">
            <p>Thank you for your business!</p>
            <p>·ûü·ûº·ûò·û¢·ûö·ûÇ·ûª·ûé!</p>
        </div>
    </div>

    <button id="printnode-btn" style="width:100%;padding:12px;margin:10px 0;">üñ® Send to PrintNode</button>

    <!-- Scripts -->
    <script src="js/apiService.js"></script> 
    <script src="js/config.js"></script>
    <script src="js/currencyHelper.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/receipt-80mm.js"></script>
    <script src="js/receipt-printer-encoder.umd.js"></script>
    <script>
        const apiKey = "fuTUtDy28kvT6oNf3V84ip-nc6P_yltRzI7Iogmf2qk";  // ‚úÖ Your PrintNode API key
        const printerId = 74589060;  // ‚úÖ Your printer ID
        
        document.getElementById('printnode-btn').addEventListener('click', async () => {
          try {
            // ‚úÖ Get sale data from localStorage
            const saleData = JSON.parse(localStorage.getItem('currentReceiptData'));
            if (!saleData) {
              alert("‚ùå No receipt data found.");
              return;
            }
        
            // ‚úÖ Build the ESC/POS receipt
            const encoder = new ReceiptPrinterEncoder({
              language: 'esc-pos',
              codepageMapping: 'epson',
              codepage: 'auto',
              columns: 42,
              feedBeforeCut: 4
            });
        
            encoder
              .initialize()
              .align('center')
              .bold(true)
              .size(2)
              .line('·ûü·ûª·ûÅ·û∂·ûï·üí·ûë·üá·ûë·ûπ·ûÄ')    // Store name in Khmer
              .size(1)
              .bold(false)
              .line('Tel: +855 78 659 799')
              .newline()
        
              // üîª Receipt Info
              .align('left')
              .line(`Receipt No: ${saleData.receipt_number || ''}`)
              .line(`Date: ${new Date(saleData.transaction_time).toLocaleString()}`)
              .line(`Cashier: ${saleData.staff?.full_name || 'Unknown'}`)
              .rule({ style: 'single' });
        
            // üõç Items
            (saleData.sale_items || []).forEach(item => {
              // ‚úÖ Use product_name instead of name
              const name = (item.product_name || '').padEnd(20).slice(0, 20);
              const qty = String(item.quantity).padStart(2);
              const price = item.price.toFixed(2);
              encoder.line(`${name} ${qty} x ${price}`);
            });
        
            // üíµ Totals
            encoder
              .rule({ style: 'single' })
              .align('right')
              .bold(true)
              .line(`Subtotal: ${saleData.total_amount.toFixed(2)} THB`)
              .line(`TOTAL: ${saleData.total_amount.toFixed(2)} THB`)
              .bold(false)
              .newline()
              .align('center')
              .line('Thank you for your business!')
              .line('·ûü·ûº·ûò·û¢·ûö·ûÇ·ûª·ûé!')
              .newline()
              .cut('full');   // ‚úÇÔ∏è Full paper cut
        
            // ‚úÖ Encode receipt to ESC/POS bytes
            const escposData = encoder.encode();
        
            // ‚úÖ Convert binary data to Base64 for PrintNode
            const base64Content = btoa(String.fromCharCode(...escposData));
        
            // ‚úÖ Send to PrintNode
            const response = await fetch("https://api.printnode.com/printjobs", {
              method: "POST",
              headers: {
                "Authorization": "Basic " + btoa(apiKey + ":"),
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                printerId: printerId,
                title: "Receipt",
                contentType: "raw_base64",
                content: base64Content,
                source: "POS System"
              })
            });
        
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || "PrintNode failed");
        
            alert("‚úÖ Receipt sent to printer!");
          } catch (err) {
            console.error("‚ùå Printing error:", err);
            alert("‚ùå Error: " + err.message);
          }
        });
        </script>



</body>
</html>
